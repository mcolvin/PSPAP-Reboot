---
title: "Effect of daily movement on abundance estimates: Robust Design"
output: 
  html_document:
    includes:
      in_header: header_banner.html 
bibliography: PSref.bib
csl: ecology.csl  
---

<!---
rmarkdown::render_site("_2017-06-XX-RD-and-closure.Rmd")# build website
--->

```{r,eval=FALSE,echo=FALSE}

source("R/6-analysis-RD-and-Closure.R")
input<-list()
input$nprim = 10
input$phi=rep(0.8,input$nprim)## SURVIVAL
# FECUNDITY
input$f=rep(0,input$nprim)
input$n=1000 # initial population size
input$n_inn=300 # initial number in study area
## RANDOM MOVEMENT PRIMARY
input$gam_prime=rep(0.7,input$nprim) # UNOBSERVABLE[t-1]--> UNOBSERVABLE[t]
input$gam_d_prime=1-input$gam_prime # OBSERVABLE[t-1] --> UNOBSERVABLE[t]
input$nsec=rep(4,input$nprim)## SECONDARY OCCASIONS
## RANDOM MOVEMENT SECONDARY
input$gam_d_prime2<-rep(0,input$nprim) # OBSERVABLE[t-1] --> UNOBSERVABLE[t]
input$gam_prime2<- 1-input$gam_d_prime2# UNOBSERVABLE[t-1]--> UNOBSERVABLE[t]
input$p=rep(0.3,input$nprim)## CAPTURE PROBABILITY
inputs<-input
#ch<-sim_ch(inputs=input)
#ests<-est_rd(inputs=ch)

combos<- expand.grid(gam_d_prime2=seq(0,0.5,by=0.05),
    reps=c(1:100))
nn<-pp<-data.frame()
for(i in 433:nrow(combos))
    {
    input$gam_d_prime2<-rep(combos$gam_d_prime2[i],input$nprim) 
    input$gam_prime2<- 1-input$gam_d_prime2
    ch<-sim_ch(inputs=input)
    ests<-est_rd(inputs=ch)  
    parms=data.frame(
        rep=i,
        gamma2=input$gam_d_prime2[1],
        gammaTrue=input$gam_d_prime[1],
        gammahat=ests$parameters[ests$parameters$parameter=="GammaDoublePrime:(Intercept)",]$ests,
        ptrue= input$p[1],  
        phat= ests$parameters[ests$parameters$parameter=="p:(Intercept)",]$ests,
        Strue=input$phi[1],
        Shat=ests$parameters[ests$parameters$parameter=="S:(Intercept)",]$ests)
    abund<-data.frame(
        rep=i,
        gamma2=input$gam_d_prime2[1],
        year=c(1:input$nprim),
        Ntrue=colSums(ch$Z_inn),        
        Nhat= ests$abundance$derived.estimate)
    pp<- rbind(pp,parms)
    nn<-rbind(nn,abund)
    }

write.csv(pp,"output/RD-daily-movement-output-parameters.csv")
write.csv(nn,"output/RD-daily-movement-output-abundance.csv")
```


```{r,echo=FALSE}
pp<-read.csv("output/RD-daily-movement-output-parameters.csv")
pp$rep<- c(1:nrow(pp))
nn<-read.csv("output/RD-daily-movement-output-abundance.csv")
nn$year<- rep(c(1:10),nrow(pp))
nn$rep<- sort(rep(pp$rep,10))
nn$bias<- nn$Nhat-nn$Ntrue
nn$pbias<- (nn$Nhat-nn$Ntrue)/nn$Ntrue
xx<- aggregate(cbind(bias,pbias)~gamma2+rep,nn,mean)
```

### In a nutshell

### Engage in the process

### Background overview

In a previous post we looked at the effect of violating the assumption 
of closure. Specifically, when Pallid Sturgeon move in and out of a bend 
on a daily basis. The analysis showed that as daily movement rates 
increased there was a positive bias associated with abundance estimates 
using the M0 abundance estimator for capture mark recapture approaches
[see here](https://mcolvin.github.io/PSPAP-Reboot/2017-06-28-M0-and-closure.html). 

To date the team has evaluated varying monitoring approaches identified 
during the workshop including catch effort and closed population estimators.


 


One alternative to a catch effort program or estimating abundance using 
a cmr estimator like the M0 model is the robust design.


 of the monitoring design alternatives proposed during the meeting 
was a capture mark capture (CMR) program that uses a robust design to 
simultaneously estimate several demographic parameters like survival, 
abundance, and movement. The estimation is possible because of the use 
of primary occasions with repeated secondary occasions nested within 
primary occasions. 


Illustration of a robust design capture recapture program with multiple 
primary occasions and secondary occasions with each primary occasion. 
The period between primary occasions is treated as an open population so 
pallid sturgeon are subject to survival and move in the system. The 
secondary occasions are assumed to be closed to movement and survival 
and therefore capture probability and abundance can be estimated. 


![](images/RD-conceptual-figure.png)



The parameters estimated include:

* $\varphi$: the probability of surviving between primary occasions, 
* $\gamma^{\prime}$:  the probability of being outside the study area and unavailable for capture during the primary occasions given the animal was not present during the previous primary occasions given it survives to the current occasion (Figure 2),
* $\gamma^{\prime\prime}$:  is the probability of being outside the study area and unavailable for capture during the primary occasions given the animal was present during the previous primary occasions given it survives to the current occasion (Figure 2),
* $c$ is the initial capture probability
* $p$ is the recapture probability, and 
* $f_0$ is number of unobserved individuals.  



Illustration of movement between primary occasion 1 (t: left circle) and 
primary occasion 2 (t+1; right circle). The arrows represent the 
possible combinations of transitioning from observable and unobservable 
at t to observable and unobservable at t+1. 

![](images/RD-conceptual-figure2.png)


In the 


The robust design is not new to Pallid Sturgeon in 
the Misso

WS14 SPP12

Relevant assumptions for the secondary periods (i.e., periods of where closure is
assumed): 


1. Stay put (Emigration = 0),
2. New fish do not enter the bend (Immigration = 0), 
3. New fish are not recruited (Recruitment = 0), and 
4. Fish do not die (Survival = 1)

We also assume:

1. Fish do not lose tags,
2. We detect tags perfectly, and
3. Capture probability is equal among fish. 

  
### Objectives

The objectives of this analysis were to evaluate the effect of 
daily movement on estimates of survival, abundance, and capture 
probability. Introduce proxies for evaluating meeting objectives.



### Effect of violating closure assumption

Not surprisingly, as daily movement rate increased, estimated bend-level 
abundance increased. This was a similar result to the analysis of the M0 
model. The figure below illustrates the effect of daily movement on 
bend-level abundance estimates over time. The red lines are 100 
replicates of true population dynamics and the black lines are the 
estimated dynamics. As daily movement rate increases the gap between the 
black and red lines increases illustrating the positive bias. 



```{r,echo=FALSE}
trans_black<- rgb(0,0,0,alpha=40,maxColorValue=255)
trans_red<- rgb(255,0,0,alpha=40,maxColorValue=255)
par(mfrow=c(4,3),mar=c(1,2,1,1),oma=c(4,4,1,1))
for(g2 in unique(nn$gamma2))
{
plot(Nhat~year,nn,type='n',las=1)
lapply(unique(nn$rep),function(x)
    {
    points(Nhat~year,nn,subset=rep==x& gamma2==g2,col=trans_black,type='l')
    points(Ntrue~year,nn,subset=rep==x & gamma2==g2,col=trans_red,type='l')
    })
mtext(side=3, paste("Daily movement rate = ",g2,sep=""),line=-1,cex=0.65)
    }
plot.new()
legend("center", c("True abundance", "Estimated abundance"),
    col=c(trans_red, trans_black),lty=1,lwd=3)
 mtext(side=1, "Year",outer=TRUE,line=2)
 mtext(side=2, "Abundance",outer=TRUE,line=2)
```

In the figure above, we can calculate the bias of each yearly estimate 
for each rep where bias is the estimated abundance minus the true 
abundance. Fortunately this is simulated data, so we know what the true 
abundance is! Bias can then be viewed as bias with fish as the units, 
for example the estimate overestimated true abundance by 200 Pallid 
Sturgeon or bias can be scaled proportionally. Proportional bias allows 
and apples to apples comparison of the abundance estimates as a 
percentage. For example, a bias of 50 pallid sturgeon if the true 
abundance was 80 is different than if the true abundance was 5000. 



Proportional bias is illustrated in the figure below where proportional 
bias was calculated for the plot above. 



```{r,echo=FALSE,cache=TRUE}
trans_black<- rgb(0,0,0,alpha=40,maxColorValue=255)
par(mfrow=c(4,3),mar=c(1,2,1,1),oma=c(4,4,1,1))
for(g2 in unique(nn$gamma2))
{
plot(pbias~year,nn,type='n',las=1)
lapply(unique(nn$rep),function(x)
    {
    points(pbias~year,nn,subset=rep==x& gamma2==g2,col=trans_black,type='l')
    })
mtext(side=3, paste("Daily movement rate = ",g2,sep=""),line=-1,cex=0.65)
    }

mtext(side=1, "Year",outer=TRUE,line=2)
mtext(side=2, "Proportional bias",outer=TRUE,line=2)
```

Using the proportional bias values illustrated above we can get the average
bias for each replicate, thus characterizing bias over the 10 year monitoring 
period. Using the mean proportional bias values we can visualize the 
effect of increasing daily movement rates on bend-level abundance estimates for a 
10 year period.


```{r,echo=FALSE,warning=FALSE, message=FALSE}
boxplot(bias~gamma2,xx,las=1, 
    ylab="Bias (Number of fish)", xlab="Movement rate")
```

Using a similar approach we can look at how estimates of survival are
effected by daily movement. 

 






